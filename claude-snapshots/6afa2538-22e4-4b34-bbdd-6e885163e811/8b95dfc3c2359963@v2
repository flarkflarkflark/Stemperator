name: Build MatrixFilter
on: [push, pull_request, workflow_dispatch]
jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        format: [clap, vst3, lv2]
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential libgl1-mesa-dev libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev libasound2-dev libjack-jackd2-dev lv2-dev
    - name: Download SDKs
      run: |
        mkdir -p external
        git clone https://github.com/free-audio/clap.git external/clap
        [ "${{ matrix.format }}" = "vst3" ] && git clone --recursive https://github.com/steinbergmedia/vst3sdk.git external/vst3sdk || true
    - name: Build
      run: |
        chmod +x build-${{ matrix.format }}.sh 2>/dev/null || true
        if [ -f build-${{ matrix.format }}.sh ]; then ./build-${{ matrix.format }}.sh; else mkdir -p build-${{ matrix.format }} && cd build-${{ matrix.format }} && cmake .. -DCMAKE_BUILD_TYPE=Release && make; fi
    - uses: actions/upload-artifact@v4
      with:
        name: MatrixFilter-Linux-${{ matrix.format }}
        path: build-${{ matrix.format }}/**/*.{so,clap,vst3,lv2}

  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        format: [clap, vst3]
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - uses: microsoft/setup-msbuild@v2
    - name: Download SDKs
      shell: bash
      run: |
        mkdir -p external
        [ "${{ matrix.format }}" = "clap" ] && git clone https://github.com/free-audio/clap.git external/clap || true
        [ "${{ matrix.format }}" = "vst3" ] && git clone --recursive https://github.com/steinbergmedia/vst3sdk.git external/vst3sdk || true
    - name: Build
      shell: cmd
      run: |
        if exist build-${{ matrix.format }}.bat (call build-${{ matrix.format }}.bat) else (mkdir build-${{ matrix.format }} && cd build-${{ matrix.format }} && cmake .. -G "Visual Studio 17 2022" -A x64 && cmake --build . --config Release)
    - uses: actions/upload-artifact@v4
      with:
        name: MatrixFilter-Windows-${{ matrix.format }}
        path: build-${{ matrix.format }}/**/*.{dll,clap,vst3}

  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        format: [clap, vst3, lv2]
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - run: brew install cmake pkg-config
    - name: Download SDKs
      run: |
        mkdir -p external
        git clone https://github.com/free-audio/clap.git external/clap
        [ "${{ matrix.format }}" = "vst3" ] && git clone --recursive https://github.com/steinbergmedia/vst3sdk.git external/vst3sdk || true
    - name: Build
      run: |
        chmod +x build-${{ matrix.format }}.sh 2>/dev/null || true
        if [ -f build-${{ matrix.format }}.sh ]; then ./build-${{ matrix.format }}.sh; else mkdir -p build-${{ matrix.format }} && cd build-${{ matrix.format }} && cmake .. -DCMAKE_BUILD_TYPE=Release && make; fi
    - uses: actions/upload-artifact@v4
      with:
        name: MatrixFilter-macOS-${{ matrix.format }}
        path: build-${{ matrix.format }}/**/*.{dylib,clap,vst3,lv2}
