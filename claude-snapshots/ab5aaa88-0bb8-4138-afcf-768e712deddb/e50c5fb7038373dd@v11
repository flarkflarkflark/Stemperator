cmake_minimum_required(VERSION 3.17)
project(MatrixFilter VERSION 1.1.0 LANGUAGES C CXX)

#-------------------------------------------------------------------------------
# CLAP Plugin Build
#-------------------------------------------------------------------------------
message(STATUS "Building MatrixFilter CLAP")

# Add CLAP SDK
add_subdirectory(external/clap EXCLUDE_FROM_ALL)

add_library(MatrixFilter SHARED)
set_target_properties(MatrixFilter PROPERTIES
    C_STANDARD 11
    CXX_STANDARD 17
)

# Include directories
target_include_directories(MatrixFilter PRIVATE
    ${CMAKE_CURRENT_SOURCE_DIR}/include
    ${CMAKE_CURRENT_SOURCE_DIR}/external/clap/include
)

# Source files
target_sources(MatrixFilter PRIVATE
    src/dsp.cpp
    src/gui.cpp
    src/gui-extension.cpp
    src/plugin.cpp
    src/plugin-extensions.cpp
    src/plugin-factory.cpp
    src/plugin-entry.cpp
)

# Link libraries
target_link_libraries(MatrixFilter PRIVATE
    m
    pthread
)

# Platform-specific settings and dependencies
if(CMAKE_SYSTEM_NAME STREQUAL "Linux")
    # Find OpenGL for Linux GUI
    find_package(OpenGL REQUIRED)
    target_link_libraries(MatrixFilter PRIVATE OpenGL::GL)

    # Find X11 for Linux GUI
    find_package(X11 REQUIRED)
    target_link_libraries(MatrixFilter PRIVATE ${X11_LIBRARIES})
    target_include_directories(MatrixFilter PRIVATE ${X11_INCLUDE_DIR})

    # Link pthread for Linux
    find_package(Threads REQUIRED)
    target_link_libraries(MatrixFilter PRIVATE Threads::Threads)

    # Symbol exports for Linux
    target_link_libraries(MatrixFilter PRIVATE -Wl,--version-script=${CMAKE_CURRENT_SOURCE_DIR}/src/symbols.map)
    target_link_libraries(MatrixFilter PRIVATE -Wl,-z,defs)
    set_target_properties(MatrixFilter PROPERTIES SUFFIX ".clap" PREFIX "lib")

elseif(CMAKE_SYSTEM_NAME STREQUAL "Darwin")
    # Find OpenGL for macOS (optional for future GUI support)
    find_package(OpenGL)
    if(OPENGL_FOUND)
        target_link_libraries(MatrixFilter PRIVATE OpenGL::GL)
    endif()

    # Symbol exports for macOS
    target_link_options(MatrixFilter PRIVATE -exported_symbols_list ${CMAKE_CURRENT_SOURCE_DIR}/src/symbols-macos.txt)
    set_target_properties(MatrixFilter PROPERTIES
        BUNDLE True
        BUNDLE_EXTENSION clap
        MACOSX_BUNDLE_GUI_IDENTIFIER com.flark.matrixfilter
        MACOSX_BUNDLE_BUNDLE_NAME "flark's MatrixFilter"
        MACOSX_BUNDLE_BUNDLE_VERSION "1.1.0"
        MACOSX_BUNDLE_SHORT_VERSION_STRING "1.1.0"
    )

elseif(CMAKE_SYSTEM_NAME STREQUAL "Windows")
    # Find OpenGL for Windows (optional for future GUI support)
    find_package(OpenGL)
    if(OPENGL_FOUND)
        target_link_libraries(MatrixFilter PRIVATE OpenGL::GL)
    endif()

    # Symbol exports for Windows
    target_link_options(MatrixFilter PRIVATE /DEF:${CMAKE_CURRENT_SOURCE_DIR}/src/symbols-windows.txt)
    set_target_properties(MatrixFilter PROPERTIES SUFFIX ".clap" PREFIX "")
endif()

# Installation
install(TARGETS MatrixFilter DESTINATION .)
install(FILES README.md DESTINATION .)
