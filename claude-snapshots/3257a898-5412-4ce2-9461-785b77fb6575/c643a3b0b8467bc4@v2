# CLAUDE.md - Stemperator

## Project Overview

**Stemperator** is a real-time stem separation VST3 plugin that uses AI/ML models (Demucs, Spleeter) to separate audio into stems:
- **Vocals** - Lead and backing vocals
- **Drums** - Percussion and drums
- **Bass** - Bass guitar and low-frequency instruments
- **Other** - Everything else (guitars, synths, keys, etc.)

The plugin can operate in real-time within a DAW or process files in the standalone application.

## Building

### Prerequisites

```bash
# Install JUCE (submodule)
git submodule add https://github.com/juce-framework/JUCE.git JUCE
git submodule update --init --recursive

# Install LibTorch (optional, for Demucs models)
# Download from https://pytorch.org/get-started/locally/
# Extract to /opt/libtorch or set TORCH_DIR

# Or use ONNX Runtime (lighter weight)
# sudo apt install libonnxruntime-dev
```

### Build Commands

```bash
mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
cmake --build . --config Release
```

### Build Options

```bash
cmake -DUSE_LIBTORCH=ON ..   # Enable Demucs (default)
cmake -DUSE_ONNX=ON ..       # Use ONNX Runtime instead
cmake -DUSE_LIBTORCH=OFF -DUSE_ONNX=OFF ..  # Spectral-only (no AI)
```

## Architecture

```
Stemperator/
├── Source/
│   ├── PluginProcessor.cpp/h    # Audio processing engine
│   ├── PluginEditor.cpp/h       # Main GUI
│   ├── DSP/
│   │   ├── StemSeparator.cpp/h      # Main separator (orchestrates)
│   │   ├── SpectralSeparator.cpp/h  # FFT-based fallback separation
│   │   └── DemucsModel.cpp/h        # AI model inference wrapper
│   ├── GUI/
│   │   ├── StemMixer.cpp/h      # 4-channel stem mixer with faders
│   │   └── WaveformView.cpp/h   # Waveform display per stem
│   └── Utils/
│       └── ModelLoader.cpp/h    # Load/manage ML models
├── models/                       # Pre-trained model files
│   ├── demucs_v4.pt             # Demucs v4 PyTorch model
│   └── htdemucs.onnx            # ONNX converted model
└── Resources/
    └── presets/                  # Factory presets
```

## DSP Pipeline

### Real-time Mode (Low Latency)
1. **Input Buffer** → Audio from DAW (stereo)
2. **Spectral Separator** → Quick FFT-based separation (for preview)
3. **Stem Mixer** → Volume/mute/solo per stem
4. **Output Buffer** → Mixed result back to DAW

### Offline/High Quality Mode
1. **Input Buffer** → Full audio file
2. **Demucs Model** → AI-based separation (GPU accelerated)
3. **Stem Storage** → Cache separated stems
4. **Stem Mixer** → Real-time mixing of cached stems
5. **Output** → Export individual stems or mix

## Stem Separation Algorithms

### 1. Spectral Separator (Fallback/Preview)
Fast FFT-based separation using:
- **Center extraction** for vocals (stereo difference)
- **Low-pass filter** for bass (<200Hz)
- **Transient detection** for drums
- **Residual** for other instruments

### 2. Demucs v4 (AI - High Quality)
Facebook/Meta's hybrid transformer model:
- Input: Stereo audio at 44.1kHz
- Output: 4 stems (vocals, drums, bass, other)
- Latency: ~6 seconds for processing
- Quality: State-of-the-art separation

### 3. ONNX Models (Lighter Weight)
Converted models for faster inference:
- Spleeter 4stems ONNX
- Open-Unmix ONNX
- Lighter resource usage

## GUI Components

### StemMixer
- 4 vertical faders (Vocals, Drums, Bass, Other)
- Mute/Solo buttons per stem
- Pan control per stem
- Master output fader
- Waveform display per stem

### Main Controls
- **Mode**: Real-time / Offline
- **Quality**: Fast / Balanced / Best
- **Export**: Save individual stems as WAV/FLAC

## Key Features

1. **Real-time Preview** - Quick spectral separation for live monitoring
2. **Offline Processing** - High-quality AI separation
3. **Stem Export** - Export individual stems to files
4. **GPU Acceleration** - CUDA/ROCm for faster AI inference
5. **Karaoke Mode** - One-click vocal removal
6. **Remix Mode** - Adjust stem levels for remixing

## Model Files

Models are loaded from `models/` directory:

| Model | Size | Quality | Speed |
|-------|------|---------|-------|
| demucs_v4.pt | 80MB | Best | Slow |
| htdemucs.onnx | 40MB | Great | Medium |
| spleeter_4stems.onnx | 30MB | Good | Fast |

## Performance Targets

- **Real-time latency**: <50ms (spectral mode)
- **Offline processing**: 2x-5x real-time (Demucs)
- **Memory usage**: <2GB RAM
- **GPU acceleration**: 10x speedup on modern GPUs

## Development Tasks

### Phase 1: Core Infrastructure
- [ ] Basic JUCE plugin structure
- [ ] Audio I/O and buffer management
- [ ] Simple GUI with 4 faders

### Phase 2: Spectral Separation
- [ ] FFT-based vocal isolation (center channel)
- [ ] Bass extraction via low-pass
- [ ] Drum detection via transients
- [ ] Residual calculation

### Phase 3: AI Integration
- [ ] LibTorch integration
- [ ] Demucs model loading
- [ ] Batch processing pipeline
- [ ] Stem caching

### Phase 4: GUI Polish
- [ ] Waveform displays
- [ ] Preset management
- [ ] Export functionality
- [ ] Settings dialog

### Phase 5: Optimization
- [ ] GPU acceleration (CUDA/ROCm)
- [ ] Multi-threading
- [ ] Memory optimization
- [ ] Real-time performance

## References

- Demucs: https://github.com/facebookresearch/demucs
- Spleeter: https://github.com/deezer/spleeter
- Open-Unmix: https://github.com/sigsep/open-unmix-pytorch
- JUCE: https://juce.com/
