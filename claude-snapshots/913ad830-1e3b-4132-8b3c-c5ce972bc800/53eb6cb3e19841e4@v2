#include "CorrectionListView.h"

CorrectionListView::CorrectionListView()
{
    table.setModel (this);
    table.setColour (juce::ListBox::outlineColourId, juce::Colours::grey);
    table.setOutlineThickness (1);
    table.setRowHeight (22);
    addAndMakeVisible (table);

    // Add columns
    table.getHeader().addColumn ("Time", TimeColumn, 100, 50, 200,
                                  juce::TableHeaderComponent::defaultFlags);
    table.getHeader().addColumn ("Magnitude", MagnitudeColumn, 80, 50, 150,
                                  juce::TableHeaderComponent::defaultFlags);
    table.getHeader().addColumn ("Width", WidthColumn, 80, 50, 150,
                                  juce::TableHeaderComponent::defaultFlags);
    table.getHeader().addColumn ("Type", TypeColumn, 80, 50, 150,
                                  juce::TableHeaderComponent::defaultFlags);
    table.getHeader().addColumn ("Applied", AppliedColumn, 80, 50, 150,
                                  juce::TableHeaderComponent::defaultFlags);
}

void CorrectionListView::addCorrection (int64_t position, float magnitude, int width,
                                       const juce::String& type, bool applied)
{
    corrections.emplace_back (position, magnitude, width, type, applied);

    // Sort by position
    std::sort (corrections.begin(), corrections.end(),
               [](const Correction& a, const Correction& b) { return a.position < b.position; });

    table.updateContent();
    repaint();
}

void CorrectionListView::clearCorrections()
{
    corrections.clear();
    table.updateContent();
    repaint();
}

void CorrectionListView::resized()
{
    table.setBounds (getLocalBounds());
}

void CorrectionListView::paint (juce::Graphics& g)
{
    g.fillAll (getLookAndFeel().findColour (juce::ResizableWindow::backgroundColourId));
}

int CorrectionListView::getNumRows()
{
    return static_cast<int> (corrections.size());
}

void CorrectionListView::paintRowBackground (juce::Graphics& g, int rowNumber,
                                             int width, int height, bool rowIsSelected)
{
    if (rowIsSelected)
        g.fillAll (juce::Colour (0xff4a90e2).withAlpha (0.3f)); // Light blue selection
    else
        g.fillAll (rowNumber % 2 ? juce::Colours::white : juce::Colour (0xfff0f0f0)); // Alternating rows
}

void CorrectionListView::paintCell (juce::Graphics& g, int rowNumber, int columnId,
                                   int width, int height, bool rowIsSelected)
{
    if (rowNumber >= static_cast<int> (corrections.size()))
        return;

    const auto& correction = corrections[rowNumber];

    g.setColour (rowIsSelected ? juce::Colours::black : juce::Colour (0xff222222));
    g.setFont (14.0f);

    juce::String text;

    switch (columnId)
    {
        case TimeColumn:
            text = formatTime (correction.position);
            break;

        case MagnitudeColumn:
            text = juce::String (correction.magnitude, 2);
            break;

        case WidthColumn:
            text = juce::String (correction.width) + " samples";
            break;

        case TypeColumn:
            text = correction.type;
            break;

        case AppliedColumn:
            text = correction.applied ? "Yes" : "No";
            g.setColour (correction.applied ? juce::Colours::green : juce::Colours::orange);
            break;
    }

    g.drawText (text, 5, 0, width - 10, height, juce::Justification::centredLeft, true);
}

void CorrectionListView::cellClicked (int rowNumber, int columnId, const juce::MouseEvent& event)
{
    if (rowNumber >= 0 && rowNumber < static_cast<int> (corrections.size()))
    {
        const auto& correction = corrections[rowNumber];

        // Notify listeners of selection
        if (onCorrectionSelected)
            onCorrectionSelected (correction.position);

        DBG ("Selected correction at: " + formatTime (correction.position));
    }
}

juce::Component* CorrectionListView::refreshComponentForCell (int rowNumber, int columnId,
                                                              bool isRowSelected,
                                                              juce::Component* existingComponentToUpdate)
{
    // No custom components needed, using paintCell instead
    return nullptr;
}

juce::String CorrectionListView::formatTime (int64_t samplePosition)
{
    double timeInSeconds = samplePosition / sampleRate;

    int hours = (int) (timeInSeconds / 3600.0);
    int minutes = (int) ((timeInSeconds - hours * 3600) / 60.0);
    double seconds = timeInSeconds - hours * 3600 - minutes * 60;

    if (hours > 0)
        return juce::String::formatted ("%d:%02d:%06.3f", hours, minutes, seconds);
    else
        return juce::String::formatted ("%d:%06.3f", minutes, seconds);
}
